#!/usr/bin/make -f

include /usr/share/quilt/quilt.make

DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

ifeq ($(DEB_BUILD_GNU_TYPE), $(DEB_HOST_GNU_TYPE))
	CONFIGURE_OPTIONS += --build $(DEB_HOST_GNU_TYPE)
else
	CONFIGURE_OPTIONS += --build $(DEB_BUILD_GNU_TYPE) \
		--host $(DEB_HOST_GNU_TYPE)
endif

CONFIGURE_OPTIONS += \
	--prefix=/usr \
	--mandir=/usr/share/man \
	--disable-dependency-tracking \
	--disable-rpath \
	--enable-warnings \
	--enable-nls \
	--with-aiksaurus \
	--with-gnu-ld \
	--without-pspell \
	--with-aspell \
	--with-x \
	--without-included-gettext \
	--without-included-boost \

LDFLAGS += -Wl,-z,defs -Wl,--as-needed

configure: patch configure-stamp
configure-stamp:
	dh_testdir

	set -e; if ! [ -f config/config.sub.backup ]; then \
		mv config/config.sub config/config.sub.backup; \
		ln -s /usr/share/misc/config.sub config/config.sub; \
	fi

	test -d build-tree || mkdir build-tree
	cd build-tree && ../configure $(CONFIGURE_OPTIONS)

	touch configure-stamp

build: configure build-stamp
build-stamp:
	dh_testdir
	cd build-tree && $(MAKE)
	touch build-stamp

clean: unpatch
	dh_testdir
	dh_testroot

	! test -e build-tree || rm -r build-tree
	! test -f config/config.sub.backup || \
		mv config/config.sub.backup config/config.sub

# clean out compiled python code left around after building
	find lib -name '*.pyc' -exec rm -v {} \;

	dh_clean

install: build
# hack: remove debhelper logs so that install target is idempotent
	rm -f debian/*.log

	dh_testdir
	dh_testroot
	dh_prep

	cd build-tree && $(MAKE) install DESTDIR=`pwd`/../debian/lyx-common

	dh_installdirs
	dh_install

# move binaries to arch package
	mv debian/lyx-common/usr/bin debian/lyx/usr/bin
	mv debian/lyx-common/usr/share/man debian/lyx/usr/share/man

# move fonts and font docs to font package
	mkdir -p debian/ttf-lyx/usr/share/fonts/truetype
	mkdir -p debian/ttf-lyx/usr/share/doc/ttf-lyx
	mv debian/lyx-common/usr/share/lyx/fonts/ReadmeBaKoMa4LyX.txt \
		debian/ttf-lyx/usr/share/doc/ttf-lyx/
	rm debian/lyx-common/usr/share/lyx/fonts/BaKoMaFontLicense.txt
	mv debian/lyx-common/usr/share/lyx/fonts \
		debian/ttf-lyx/usr/share/fonts/truetype/ttf-lyx

# remove empty directory
	rmdir debian/lyx-common/usr/share/lyx/images/commands

	mv debian/lyx-common/usr/share/lyx/tex \
		debian/lyx-common/usr/share/texmf/tex/latex/lyx
	cp debian/bash_completion debian/lyx-common/etc/bash_completion.d/lyx

	dh_link
	dh_pysupport /usr/share/lyx
	dh_installtex -plyx-common
	dh_installdefoma -pttf-lyx

# now run the rest of the debhelper commands
	dh install --after dh_install

binary-indep: build install
	dh binary-indep --before builddeb
	dh_builddeb -i -- -Z bzip2

binary-arch: build install
	dh binary-arch --before builddeb
	dh_builddeb -a -- -Z bzip2

binary: binary-indep binary-arch
