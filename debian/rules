#!/usr/bin/make -f

DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

ifeq ($(DEB_BUILD_GNU_TYPE), $(DEB_HOST_GNU_TYPE))
	CONFIGURE_OPTIONS += --build $(DEB_HOST_GNU_TYPE)
else
	CONFIGURE_OPTIONS += --build $(DEB_BUILD_GNU_TYPE) \
		--host $(DEB_HOST_GNU_TYPE)
endif

CONFIGURE_OPTIONS += \
	--prefix=/usr \
	--mandir=/usr/share/man \
	--disable-dependency-tracking \
	--disable-rpath \
	--enable-warnings \
	--enable-nls \
	--with-gnu-ld \
	--without-aspell \
	--without-hunspell \
	--with-enchant \
	--with-x \
	--without-included-gettext \
	--without-included-boost \

LDFLAGS += -Wl,-z,defs -Wl,--as-needed

%:
	dh $@ --with autotools_dev

override_dh_auto_configure:
	test -d build-tree || mkdir build-tree
	cd build-tree && ../configure $(CONFIGURE_OPTIONS)

override_dh_auto_build:
	cd build-tree && $(MAKE)

override_dh_auto_clean:
	! test -e build-tree || rm -r build-tree

# clean out compiled python code left around after building
	find lib -name '*.pyc' -exec rm -v {} \;

override_dh_auto_install:
	cd build-tree && $(MAKE) install DESTDIR=`pwd`/../debian/lyx-common

# move binaries to arch package
	mkdir -p debian/lyx/usr/share
	mv debian/lyx-common/usr/bin debian/lyx/usr/bin
	mv debian/lyx-common/usr/share/man debian/lyx/usr/share/man

# move fonts to font package
	mkdir -p debian/ttf-lyx/usr/share/fonts/truetype
	mv debian/lyx-common/usr/share/lyx/fonts \
		debian/ttf-lyx/usr/share/fonts/truetype/ttf-lyx

# remove empty directory
	rmdir debian/lyx-common/usr/share/lyx/images/commands

# move tex files to correct place
	mkdir -p debian/lyx-common/usr/share/texmf/tex/latex
	mv debian/lyx-common/usr/share/lyx/tex \
		debian/lyx-common/usr/share/texmf/tex/latex/lyx

# install bash completion in the correct location
	mkdir -p debian/lyx-common/etc/bash_completion.d
	install --mode=644 lib/scripts/bash_completion \
		debian/lyx-common/etc/bash_completion.d/lyx
	rm debian/lyx-common/usr/share/lyx/scripts/bash_completion

# remove exec permissions on scripts without proper shebang
	chmod -x debian/lyx-common/usr/share/lyx/scripts/lyxsweave.R
	chmod -x debian/lyx-common/usr/share/lyx/scripts/include_bib.py

override_dh_installdocs:
	mkdir -p debian/lyx/usr/share/doc
	ln -s lyx-common debian/lyx/usr/share/doc/lyx

	dh_installdocs

	mkdir -p debian/ttf-lyx/usr/share/doc/ttf-lyx
	mv debian/ttf-lyx/usr/share/fonts/truetype/ttf-lyx/ReadmeBaKoMa4LyX.txt \
		debian/ttf-lyx/usr/share/doc/ttf-lyx/
	rm debian/ttf-lyx/usr/share/fonts/truetype/ttf-lyx/BaKoMaFontLicense.txt

override_dh_pysupport:
	dh_pysupport /usr/share/lyx

override_dh_install:
	dh_install
	dh_installtex -plyx-common
	dh_installdefoma -pttf-lyx

override_dh_builddeb:
	dh_builddeb -- -Z bzip2
